# Please edit config.yml.j2, and use the script generate_circleci_config.py
# to generate a dynamic CircleCI configuration
version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@0.2.0

workflows:
  setup:
    jobs:
      # - generate-config
      - rebase-astro-main

executors:
  docker-executor:
    docker:
      - image: circleci/python:3.9

jobs:
  # Runs dynamic workflow generator and continues from it
  generate-config:
    executor: docker-executor
    steps:
      - checkout
      - run:
          name: Install generation dependencies
          command: pip install jinja2
      - run:
          name: Generate config
          command: |
            python3 .circleci/generate_circleci_config.py > generated_config.yml
            cat generated_config.yml
      - continuation/continue:
          configuration_path: generated_config.yml
  rebase-astro-main:
    machine:
      image: ubuntu-2004:202107-02
    steps:
      - add_ssh_keys:
          fingerprints:
            - "11:0b:15:6b:f2:77:3e:93:c5:83:0e:8a:0a:93:2e:7e"
      - run:
          name: Rebase astronomer/airflow:astro-main onto main
          command: |
            export GIT_SSH_COMMAND="ssh -o IdentitiesOnly=yes -i $HOME/.ssh/id_rsa_110b156bf2773e93c5830e8a0a932e7e"
            git clone git@github.com:astronomer/airflow.git
            cd airflow
            git branch --verbose
            git fetch --all
            git checkout astro-main
            git --no-pager log --max-count 4
            git rebase main
            git --no-pager log --max-count 4
            git push origin astro-main
            git --no-pager remote --verbose

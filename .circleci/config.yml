# Warning: automatically generated file
# Please edit config.yml.j2, and use the script generate_circleci_config.py
version: 2.1

workflows:
  certified-airflow:
    jobs:
      - static-checks
      - slack/on-hold:
          name: Slack_Notification-1.10.10
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-1.10.10
          requires:
            - Slack_Notification-1.10.10
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-1.10.10-alpine3.10
          airflow_version: 1.10.10
          distribution_name: alpine3.10
          dev_build: false
          requires:
            - Need-Approval-1.10.10
            - static-checks
      - scan-trivy:
          name: scan-trivy-1.10.10-alpine3.10-onbuild
          airflow_version: 1.10.10
          distribution: alpine3.10
          distribution_name: alpine3.10-onbuild
          requires:
            - build-1.10.10-alpine3.10
      - test:
          name: test-1.10.10-alpine3.10-images
          tag: "1.10.10-alpine3.10"
          requires:
            - build-1.10.10-alpine3.10
      - push:
          name: push-1.10.10-alpine3.10
          dev_build: false
          tag: "1.10.10-alpine3.10"
          extra_tags: "1.10.10-alpine3.10-${CIRCLE_BUILD_NUM},1.10.10-10-alpine3.10"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.10-alpine3.10-onbuild
            - test-1.10.10-alpine3.10-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-1.10.10-alpine3.10-onbuild
          dev_build: false
          tag: "1.10.10-alpine3.10-onbuild"
          extra_tags: "1.10.10-alpine3.10-onbuild-${CIRCLE_BUILD_NUM},1.10.10-10-alpine3.10-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.10-alpine3.10-onbuild
            - test-1.10.10-alpine3.10-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - build:
          name: build-1.10.10-buster
          airflow_version: 1.10.10
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-1.10.10
            - static-checks
      - scan-trivy:
          name: scan-trivy-1.10.10-buster-onbuild
          airflow_version: 1.10.10
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-1.10.10-buster
      - test:
          name: test-1.10.10-buster-images
          tag: "1.10.10-buster"
          requires:
            - build-1.10.10-buster
      - push:
          name: push-1.10.10-buster
          dev_build: false
          tag: "1.10.10-buster"
          extra_tags: "1.10.10-buster-${CIRCLE_BUILD_NUM},1.10.10-10-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.10-buster-onbuild
            - test-1.10.10-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-1.10.10-buster-onbuild
          dev_build: false
          tag: "1.10.10-buster-onbuild"
          extra_tags: "1.10.10-buster-onbuild-${CIRCLE_BUILD_NUM},1.10.10-10-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.10-buster-onbuild
            - test-1.10.10-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-1.10.12
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-1.10.12
          requires:
            - Slack_Notification-1.10.12
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-1.10.12-alpine3.10
          airflow_version: 1.10.12
          distribution_name: alpine3.10
          dev_build: false
          requires:
            - Need-Approval-1.10.12
            - static-checks
      - scan-trivy:
          name: scan-trivy-1.10.12-alpine3.10-onbuild
          airflow_version: 1.10.12
          distribution: alpine3.10
          distribution_name: alpine3.10-onbuild
          requires:
            - build-1.10.12-alpine3.10
      - test:
          name: test-1.10.12-alpine3.10-images
          tag: "1.10.12-alpine3.10"
          requires:
            - build-1.10.12-alpine3.10
      - push:
          name: push-1.10.12-alpine3.10
          dev_build: false
          tag: "1.10.12-alpine3.10"
          extra_tags: "1.10.12-alpine3.10-${CIRCLE_BUILD_NUM},1.10.12-6-alpine3.10"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.12-alpine3.10-onbuild
            - test-1.10.12-alpine3.10-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-1.10.12-alpine3.10-onbuild
          dev_build: false
          tag: "1.10.12-alpine3.10-onbuild"
          extra_tags: "1.10.12-alpine3.10-onbuild-${CIRCLE_BUILD_NUM},1.10.12-6-alpine3.10-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.12-alpine3.10-onbuild
            - test-1.10.12-alpine3.10-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - build:
          name: build-1.10.12-buster
          airflow_version: 1.10.12
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-1.10.12
            - static-checks
      - scan-trivy:
          name: scan-trivy-1.10.12-buster-onbuild
          airflow_version: 1.10.12
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-1.10.12-buster
      - test:
          name: test-1.10.12-buster-images
          tag: "1.10.12-buster"
          requires:
            - build-1.10.12-buster
      - push:
          name: push-1.10.12-buster
          dev_build: false
          tag: "1.10.12-buster"
          extra_tags: "1.10.12-buster-${CIRCLE_BUILD_NUM},1.10.12-6-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.12-buster-onbuild
            - test-1.10.12-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-1.10.12-buster-onbuild
          dev_build: false
          tag: "1.10.12-buster-onbuild"
          extra_tags: "1.10.12-buster-onbuild-${CIRCLE_BUILD_NUM},1.10.12-6-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.12-buster-onbuild
            - test-1.10.12-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-1.10.14
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-1.10.14
          requires:
            - Slack_Notification-1.10.14
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-1.10.14-buster
          airflow_version: 1.10.14
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-1.10.14
            - static-checks
      - scan-trivy:
          name: scan-trivy-1.10.14-buster-onbuild
          airflow_version: 1.10.14
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-1.10.14-buster
      - test:
          name: test-1.10.14-buster-images
          tag: "1.10.14-buster"
          requires:
            - build-1.10.14-buster
      - push:
          name: push-1.10.14-buster
          dev_build: false
          tag: "1.10.14-buster"
          extra_tags: "1.10.14-buster-${CIRCLE_BUILD_NUM},1.10.14-5-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.14-buster-onbuild
            - test-1.10.14-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-1.10.14-buster-onbuild
          dev_build: false
          tag: "1.10.14-buster-onbuild"
          extra_tags: "1.10.14-buster-onbuild-${CIRCLE_BUILD_NUM},1.10.14-5-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.14-buster-onbuild
            - test-1.10.14-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-1.10.15
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-1.10.15
          requires:
            - Slack_Notification-1.10.15
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-1.10.15-buster
          airflow_version: 1.10.15
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-1.10.15
            - static-checks
      - scan-trivy:
          name: scan-trivy-1.10.15-buster-onbuild
          airflow_version: 1.10.15
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-1.10.15-buster
      - test:
          name: test-1.10.15-buster-images
          tag: "1.10.15-buster"
          requires:
            - build-1.10.15-buster
      - push:
          name: push-1.10.15-buster
          dev_build: false
          tag: "1.10.15-buster"
          extra_tags: "1.10.15-buster-${CIRCLE_BUILD_NUM},1.10.15-4-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.15-buster-onbuild
            - test-1.10.15-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-1.10.15-buster-onbuild
          dev_build: false
          tag: "1.10.15-buster-onbuild"
          extra_tags: "1.10.15-buster-onbuild-${CIRCLE_BUILD_NUM},1.10.15-4-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-1.10.15-buster-onbuild
            - test-1.10.15-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.0.0
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.0.0
          requires:
            - Slack_Notification-2.0.0
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.0.0-buster
          airflow_version: 2.0.0
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-2.0.0
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.0.0-buster-onbuild
          airflow_version: 2.0.0
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-2.0.0-buster
      - test:
          name: test-2.0.0-buster-images
          tag: "2.0.0-buster"
          requires:
            - build-2.0.0-buster
      - push:
          name: push-2.0.0-buster
          dev_build: false
          tag: "2.0.0-buster"
          extra_tags: "2.0.0-buster-${CIRCLE_BUILD_NUM},2.0.0-10-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.0.0-buster-onbuild
            - test-2.0.0-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.0.0-buster-onbuild
          dev_build: false
          tag: "2.0.0-buster-onbuild"
          extra_tags: "2.0.0-buster-onbuild-${CIRCLE_BUILD_NUM},2.0.0-10-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.0.0-buster-onbuild
            - test-2.0.0-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.0.2
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.0.2
          requires:
            - Slack_Notification-2.0.2
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.0.2-buster
          airflow_version: 2.0.2
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-2.0.2
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.0.2-buster-onbuild
          airflow_version: 2.0.2
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-2.0.2-buster
      - test:
          name: test-2.0.2-buster-images
          tag: "2.0.2-buster"
          requires:
            - build-2.0.2-buster
      - push:
          name: push-2.0.2-buster
          dev_build: false
          tag: "2.0.2-buster"
          extra_tags: "2.0.2-buster-${CIRCLE_BUILD_NUM},2.0.2-6-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.0.2-buster-onbuild
            - test-2.0.2-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.0.2-buster-onbuild
          dev_build: false
          tag: "2.0.2-buster-onbuild"
          extra_tags: "2.0.2-buster-onbuild-${CIRCLE_BUILD_NUM},2.0.2-6-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.0.2-buster-onbuild
            - test-2.0.2-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.1.0
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.1.0
          requires:
            - Slack_Notification-2.1.0
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.1.0-buster
          airflow_version: 2.1.0
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-2.1.0
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.1.0-buster-onbuild
          airflow_version: 2.1.0
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-2.1.0-buster
      - test:
          name: test-2.1.0-buster-images
          tag: "2.1.0-buster"
          requires:
            - build-2.1.0-buster
      - push:
          name: push-2.1.0-buster
          dev_build: false
          tag: "2.1.0-buster"
          extra_tags: "2.1.0-buster-${CIRCLE_BUILD_NUM},2.1.0-5-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.0-buster-onbuild
            - test-2.1.0-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.1.0-buster-onbuild
          dev_build: false
          tag: "2.1.0-buster-onbuild"
          extra_tags: "2.1.0-buster-onbuild-${CIRCLE_BUILD_NUM},2.1.0-5-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.0-buster-onbuild
            - test-2.1.0-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.1.1
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.1.1
          requires:
            - Slack_Notification-2.1.1
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.1.1-buster
          airflow_version: 2.1.1
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-2.1.1
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.1.1-buster-onbuild
          airflow_version: 2.1.1
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-2.1.1-buster
      - test:
          name: test-2.1.1-buster-images
          tag: "2.1.1-buster"
          requires:
            - build-2.1.1-buster
      - push:
          name: push-2.1.1-buster
          dev_build: false
          tag: "2.1.1-buster"
          extra_tags: "2.1.1-buster-${CIRCLE_BUILD_NUM},2.1.1-4-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.1-buster-onbuild
            - test-2.1.1-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.1.1-buster-onbuild
          dev_build: false
          tag: "2.1.1-buster-onbuild"
          extra_tags: "2.1.1-buster-onbuild-${CIRCLE_BUILD_NUM},2.1.1-4-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.1-buster-onbuild
            - test-2.1.1-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.1.3
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.1.3
          requires:
            - Slack_Notification-2.1.3
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.1.3-buster
          airflow_version: 2.1.3
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-2.1.3
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.1.3-buster-onbuild
          airflow_version: 2.1.3
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-2.1.3-buster
      - test:
          name: test-2.1.3-buster-images
          tag: "2.1.3-buster"
          requires:
            - build-2.1.3-buster
      - push:
          name: push-2.1.3-buster
          dev_build: false
          tag: "2.1.3-buster"
          extra_tags: "2.1.3-buster-${CIRCLE_BUILD_NUM},2.1.3-2-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.3-buster-onbuild
            - test-2.1.3-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.1.3-buster-onbuild
          dev_build: false
          tag: "2.1.3-buster-onbuild"
          extra_tags: "2.1.3-buster-onbuild-${CIRCLE_BUILD_NUM},2.1.3-2-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.3-buster-onbuild
            - test-2.1.3-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.1.4
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.1.4
          requires:
            - Slack_Notification-2.1.4
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.1.4-buster
          airflow_version: 2.1.4
          distribution_name: buster
          dev_build: false
          requires:
            - Need-Approval-2.1.4
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.1.4-buster-onbuild
          airflow_version: 2.1.4
          distribution: buster
          distribution_name: buster-onbuild
          requires:
            - build-2.1.4-buster
      - test:
          name: test-2.1.4-buster-images
          tag: "2.1.4-buster"
          requires:
            - build-2.1.4-buster
      - push:
          name: push-2.1.4-buster
          dev_build: false
          tag: "2.1.4-buster"
          extra_tags: "2.1.4-buster-${CIRCLE_BUILD_NUM},2.1.4-2-buster"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.4-buster-onbuild
            - test-2.1.4-buster-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.1.4-buster-onbuild
          dev_build: false
          tag: "2.1.4-buster-onbuild"
          extra_tags: "2.1.4-buster-onbuild-${CIRCLE_BUILD_NUM},2.1.4-2-buster-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.1.4-buster-onbuild
            - test-2.1.4-buster-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.2.0
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.2.0
          requires:
            - Slack_Notification-2.2.0
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.2.0-bullseye
          airflow_version: 2.2.0
          distribution_name: bullseye
          dev_build: true
          extra_args: "--build-arg VERSION=$(curl https://pip.astronomer.io/simple/astronomer-certified/latest-2.2.0.build)"
          requires:
            - Need-Approval-2.2.0
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.2.0-bullseye-onbuild
          airflow_version: 2.2.0
          distribution: bullseye
          distribution_name: bullseye-onbuild
          requires:
            - build-2.2.0-bullseye
      - test:
          name: test-2.2.0-bullseye-images
          tag: "2.2.0"
          requires:
            - build-2.2.0-bullseye
      - push:
          name: push-2.2.0-bullseye
          dev_build: true
          tag: "2.2.0"
          extra_tags: "2.2.0-${CIRCLE_BUILD_NUM},2.2.0-3.dev"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.0-bullseye-onbuild
            - test-2.2.0-bullseye-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.2.0-bullseye-onbuild
          dev_build: true
          tag: "2.2.0-onbuild"
          extra_tags: "2.2.0-onbuild-${CIRCLE_BUILD_NUM},2.2.0-3.dev-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.0-bullseye-onbuild
            - test-2.2.0-bullseye-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
      - slack/on-hold:
          name: Slack_Notification-2.2.1
          context: slack_ap-airflow
          custom: |
            {
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "$CIRCLE_JOB On Hold- Awaiting Approval :raised_hand:",
                      "emoji": true
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Project*:$CIRCLE_PROJECT_REPONAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Branch*:$CIRCLE_BRANCH"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Author*:$CIRCLE_USERNAME"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Pull Request*:$CIRCLE_PULL_REQUEST"
                      }

                    ]
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Mentions*:<@UHRPL613K>,<@U018NSS9G2Y>"
                      }
                    ]
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow"
                        },
                        "url": "https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}"
                      }
                    ]
                  }
                ]
              }
          requires:
            - static-checks
          filters:
            branches:
              only:
                - master
      - pause_workflow:
          name: Need-Approval-2.2.1
          requires:
            - Slack_Notification-2.2.1
          type: approval
          filters:
            branches:
              only:
                - master

      - build:
          name: build-2.2.1-bullseye
          airflow_version: 2.2.1
          distribution_name: bullseye
          dev_build: true
          extra_args: "--build-arg VERSION=$(curl https://pip.astronomer.io/simple/astronomer-certified/latest-2.2.1.build)"
          requires:
            - Need-Approval-2.2.1
            - static-checks
      - scan-trivy:
          name: scan-trivy-2.2.1-bullseye-onbuild
          airflow_version: 2.2.1
          distribution: bullseye
          distribution_name: bullseye-onbuild
          requires:
            - build-2.2.1-bullseye
      - test:
          name: test-2.2.1-bullseye-images
          tag: "2.2.1"
          requires:
            - build-2.2.1-bullseye
      - push:
          name: push-2.2.1-bullseye
          dev_build: true
          tag: "2.2.1"
          extra_tags: "2.2.1-${CIRCLE_BUILD_NUM},2.2.1-1.dev"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.1-bullseye-onbuild
            - test-2.2.1-bullseye-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.2.1-bullseye-onbuild
          dev_build: true
          tag: "2.2.1-onbuild"
          extra_tags: "2.2.1-onbuild-${CIRCLE_BUILD_NUM},2.2.1-1.dev-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.1-bullseye-onbuild
            - test-2.2.1-bullseye-images
          filters:
            branches:
              only:
                - master
                - slack-build-approvals
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - build:
          name: build-2.2.0-bullseye
          airflow_version: 2.2.0
          distribution_name: bullseye
          dev_build: true
          extra_args: "--build-arg VERSION=$(curl https://pip.astronomer.io/simple/astronomer-certified/latest-2.2.0.build)"
      - scan-trivy:
          name: scan-trivy-2.2.0-bullseye-onbuild
          airflow_version: 2.2.0
          distribution: bullseye
          distribution_name: bullseye-onbuild
          requires:
            - build-2.2.0-bullseye
      - test:
          name: test-2.2.0-bullseye-images
          tag: "2.2.0-bullseye"
          requires:
            - build-2.2.0-bullseye
      - push:
          name: push-2.2.0-bullseye
          dev_build: true
          tag: "2.2.0-bullseye"
          extra_tags: "2.2.0-bullseye-${CIRCLE_BUILD_NUM}"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.0-bullseye-onbuild
            - test-2.2.0-bullseye-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.2.0-bullseye-onbuild
          dev_build: true
          tag: "2.2.0-onbuild"
          extra_tags: "2.2.0-onbuild-${CIRCLE_BUILD_NUM},2.2.0-3.dev-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.0-bullseye-onbuild
            - test-2.2.0-bullseye-images
          filters:
            branches:
              only:
                - master
      - build:
          name: build-2.2.1-bullseye
          airflow_version: 2.2.1
          distribution_name: bullseye
          dev_build: true
          extra_args: "--build-arg VERSION=$(curl https://pip.astronomer.io/simple/astronomer-certified/latest-2.2.1.build)"
      - scan-trivy:
          name: scan-trivy-2.2.1-bullseye-onbuild
          airflow_version: 2.2.1
          distribution: bullseye
          distribution_name: bullseye-onbuild
          requires:
            - build-2.2.1-bullseye
      - test:
          name: test-2.2.1-bullseye-images
          tag: "2.2.1-bullseye"
          requires:
            - build-2.2.1-bullseye
      - push:
          name: push-2.2.1-bullseye
          dev_build: true
          tag: "2.2.1-bullseye"
          extra_tags: "2.2.1-bullseye-${CIRCLE_BUILD_NUM}"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.1-bullseye-onbuild
            - test-2.2.1-bullseye-images
          filters:
            branches:
              only:
                - master
      - push:
          name: push-2.2.1-bullseye-onbuild
          dev_build: true
          tag: "2.2.1-onbuild"
          extra_tags: "2.2.1-onbuild-${CIRCLE_BUILD_NUM},2.2.1-1.dev-onbuild"
          context:
            - quay.io
            - docker.io
          requires:
            - scan-trivy-2.2.1-bullseye-onbuild
            - test-2.2.1-bullseye-images
          filters:
            branches:
              only:
                - master

jobs:
  static-checks:
    executor: machine-executor
    description: Static Checks
    steps:
      - checkout
      - run:
          name: Load archived Docker image
          command: |
            pyenv global 3.8.5
            pip install -r .circleci/test-requirements.txt
            pre-commit run --all-files || { git --no-pager diff && false ; }
  build:
    executor: docker-executor
    description: Build Airflow images
    parameters:
      airflow_version:
        description: "The Airflow version, for example '1.10.5'"
        type: string
      distribution_name:
        description: "The base distribution of the container"
        type: string
      dev_build:
        description: "Indicate if this is a dev build"
        type: boolean
      extra_args:
        description: "Extra args to pass to pass to Docker build command"
        default: ""
        type: string
    steps:
      - docker-build-base-and-onbuild:
          airflow_version: "<< parameters.airflow_version >>"
          distribution_name: "<< parameters.distribution_name >>"
          extra_args: "<< parameters.extra_args >>"
  test:
    executor: machine-executor
    description: Test Airflow images
    parameters:
      tag:
        type: string
    steps:
      - airflow-image-test:
          tag: "<< parameters.tag >>"
  scan-trivy:
    docker:
      - image: docker:18.09-git
    description: "Trivy: Vulnerability scanner a Docker image"
    parameters:
      airflow_version:
        description: "The Airflow version, for example '1.10.5'"
        type: string
      distribution_name:
        description: "The base distribution of the container"
        type: string
      distribution:
        description: "The distribution without onbuild"
        type: string
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Docker image
          command: docker load -i /tmp/workspace/saved-images/ap-airflow:<< parameters.airflow_version >>-<< parameters.distribution_name >>.tar
      - run:
          name: Install trivy
          command: |
            apk add --update-cache --upgrade curl rpm
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/master/contrib/install.sh | sh -s -- -b /usr/local/bin
      - restore_cache:
          keys:
            - trivy-cache
      - run:
          name: Scan the local image with trivy
          command: |
            trivy \
              --ignorefile "./<< parameters.airflow_version >>/<< parameters.distribution >>/trivyignore" \
              --cache-dir /tmp/workspace/trivy-cache \
              --ignore-unfixed -s HIGH,CRITICAL \
              --exit-code 1 \
              --no-progress "ap-airflow:<< parameters.airflow_version >>-<< parameters.distribution_name >>"
      - save_cache:
          key: trivy-cache
          paths:
            - /tmp/workspace/trivy-cache
  push:
    executor: docker-executor
    description: Push Airflow images
    parameters:
      dev_build:
        description: "Indicate if this is a dev build"
        type: boolean
      tag:
        type: string
      extra_tags:
        type: string
        default: ""
      prod_docker_repo_docker_hub:
        description: "The docker repo to tag and push to, for example 'quay.io/astronomer/ap-airflow'"
        default: "astronomerinc/ap-airflow"
        type: string
      prod_docker_repo_quay_io:
        description: "The docker repo to tag and push to, for example 'quay.io/astronomer/ap-airflow'"
        default: "quay.io/astronomer/ap-airflow"
        type: string
      dev_docker_repo_quay_io:
        description: "The docker repo to tag and push to, for example 'quay.io/astronomer/ap-airflow'"
        default: "quay.io/astronomer/ap-airflow-dev"
        type: string
    steps:
      - push:
          dev_release: "<< parameters.dev_build >>"
          extra_tags: "<< parameters.extra_tags >>"
          tag: "<< parameters.tag >>"
          prod_docker_repo_docker_hub: "<< parameters.prod_docker_repo_docker_hub >>"
          prod_docker_repo_quay_io: "<< parameters.prod_docker_repo_quay_io >>"
          dev_docker_repo_quay_io: "<< parameters.dev_docker_repo_quay_io >>"

orbs:
  slack: circleci/slack@4.2.0
  clair-scanner: ovotech/clair-scanner@1.6.0
executors:
  docker-executor:
    docker:
      - image: circleci/python:3
  machine-executor:
    machine:
      image: ubuntu-2004:202010-01

commands:
  docker-build-base-and-onbuild:
    description: "Build Airflow images to use with the Astronomer platform"
    parameters:
      airflow_version:
        type: string
        default: 1.10.5
      distribution_name:
        type: string
        default: alpine
      extra_args:
        description: "Extra args to pass to pass to Docker build command"
        default: ""
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - docker-build:
          image_name: "ap-airflow:<< parameters.airflow_version >>-<< parameters.distribution_name >>"
          path: "<< parameters.airflow_version >>/<< parameters.distribution_name >>"
          extra_args: "<< parameters.extra_args >>"
      - docker-build:
          image_name: "ap-airflow:<< parameters.airflow_version >>-<< parameters.distribution_name >>-onbuild"
          path: "common/"
          dockerfile: "Dockerfile.onbuild-<< parameters.distribution_name >>"
          extra_args: "--build-arg baseimage=ap-airflow:<< parameters.airflow_version >>-<< parameters.distribution_name >>"
      - persist_to_workspace:
          root: .
          paths:
            - saved-images/
  docker-build:
    description: "Build a Docker image"
    parameters:
      dockerfile:
        type: string
        default: Dockerfile
      path:
        type: string
        default: "."
      image_name:
        type: string
        default: $CIRCLE_PROJECT_REPONAME
      extra_args:
        type: string
        default: ""
    steps:
      - run:
          name: Build the Docker image
          command: |
            set -xe
            mkdir -p saved-images/"$(dirname '<< parameters.image_name >>')"
            docker build \
              --tag '<< parameters.image_name >>' \
              --label io.astronomer.docker.build_time="$(date +%s)" \
              --label io.astronomer.repo.commit_sha="${CIRCLE_SHA1}" \
              --label io.astronomer.repo.url="${CIRCLE_REPOSITORY_URL}" \
              --label io.astronomer.ci.build_url="${CIRCLE_BUILD_URL}" \
              --file '<< parameters.path>>/<< parameters.dockerfile >>' \
              --build-arg "BUILD_NUMBER=${CIRCLE_BUILD_NUM}" \
              --build-arg "REPO_BRANCH=${CIRCLE_BRANCH}" \
              << parameters.extra_args >> '<< parameters.path >>'
            docker save -o saved-images/<< parameters.image_name >>.tar '<< parameters.image_name >>'
  airflow-image-test:
    description: Test an Airflow image
    parameters:
      tag:
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Load archived Airflow Docker image
          command: |
            docker load -i /tmp/workspace/saved-images/ap-airflow:<< parameters.tag >>.tar
            docker load -i /tmp/workspace/saved-images/ap-airflow:<< parameters.tag >>-onbuild.tar
      - run:
          name: Test Airflow Docker images (Base + Onbuild)
          command: |
            set -e
            pyenv global 3.8.5
            pip install -r .circleci/test-requirements.txt
            .circleci/bin/test-airflow 'ap-airflow' '<< parameters.tag >>'
      - store_test_results:
          path: /tmp/test-reports
  push:
    description: "Push a Docker image to DockerHub"
    parameters:
      dev_release:
        description: "Indicate if this is a dev release"
        default: true
        type: boolean
      extra_tags:
        type: string
        default: ""
      tag:
        type: string
      image_name:
        default: ap-airflow
        type: string
      prod_docker_repo_docker_hub:
        default: astronomerinc/ap-airflow
        type: string
      prod_docker_repo_quay_io:
        default: quay.io/astronomer/ap-airflow
        type: string
      dev_docker_repo_quay_io:
        default: "quay.io/astronomer/ap-airflow-dev"
        type: string
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - setup_remote_docker
      - run:
          name: Load archived Docker image
          command: docker load -i '/tmp/workspace/saved-images/ap-airflow:<< parameters.tag >>.tar'
      - run:
          name: Login to DockerHub
          command: echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin docker.io
      - run:
          name: Login to Quay.io
          command: echo "$QUAY_PASSWORD" | docker login --username "$QUAY_USERNAME" --password-stdin quay.io
      - run:
          name: Push Docker image(s)
          command: |
            set -e
            image="ap-airflow:<< parameters.tag >>"
            set -x
            export NEW_POINT_RELEASE=true
            for tag in $(echo "<< parameters.extra_tags >>" | sed "s/,/ /g");
            do
              if DOCKER_CLI_EXPERIMENTAL=enabled docker manifest inspect "<< parameters.prod_docker_repo_docker_hub >>:$tag" >/dev/null 2>&1; then
                echo "Image with Tag ("<< parameters.prod_docker_repo_docker_hub >>:$tag") already exists"
                export NEW_POINT_RELEASE=false
              elif [[ "$tag" == "<< parameters.tag >>-$CIRCLE_BUILD_NUM" ]] || <<parameters.dev_release >> ; then
                echo "Tagging and pushing image <<parameters.image_name>>:$tag to << parameters.dev_docker_repo_quay_io >>"
                docker tag "$image" "<< parameters.dev_docker_repo_quay_io >>:${tag}"
                docker push "<< parameters.dev_docker_repo_quay_io >>:${tag}"

              else
                echo "Tagging and pushing image <<parameters.image_name>>:$tag to << parameters.prod_docker_repo_quay_io >>"
                docker tag "$image" "<< parameters.prod_docker_repo_quay_io >>:${tag}"
                docker push "<< parameters.prod_docker_repo_quay_io >>:${tag}"

                echo "Tagging and pushing image <<parameters.image_name>>:$tag to << parameters.prod_docker_repo_docker_hub >>"
                docker tag "$image" "<< parameters.prod_docker_repo_docker_hub >>:${tag}"
                docker push "<< parameters.prod_docker_repo_docker_hub >>:${tag}"

                echo "Tagging and pushing image <<parameters.image_name>>:$tag to << parameters.dev_docker_repo_quay_io >>"
                docker tag "$image" "<< parameters.dev_docker_repo_quay_io >>:${tag}"
                docker push "<< parameters.dev_docker_repo_quay_io >>:${tag}"

              fi
            done

            # The following code block publishes Moving Master builds (e.g. 1.10.13-buster-onbuild)
            # as compared to above code-blocks that publish images with build-number & immutable tag
            # e.g (e.g. 1.10.13-1-buster-onbuild and 1.10.13-buster-onbuild-24119)
            if $NEW_POINT_RELEASE ; then
              if ! <<parameters.dev_release >> ; then
                # If it is not a Dev Release publish the image to Prod Repos
                echo "Tagging and pushing image <<parameters.image_name>>:<< parameters.tag >> to << parameters.prod_docker_repo_quay_io >>"
                docker tag "$image" "<< parameters.prod_docker_repo_quay_io >>:<< parameters.tag >>"
                docker push "<< parameters.prod_docker_repo_quay_io >>:<< parameters.tag >>"

                echo "Tagging and pushing image <<parameters.image_name>>:<< parameters.tag >> to << parameters.prod_docker_repo_docker_hub >>"
                docker tag "$image" "<< parameters.prod_docker_repo_docker_hub >>:<< parameters.tag >>"
                docker push "<< parameters.prod_docker_repo_docker_hub >>:<< parameters.tag >>"
              fi

              echo "Tagging and pushing image <<parameters.image_name>>:<< parameters.tag >> to << parameters.dev_docker_repo_quay_io >>"
              docker tag "$image" "<< parameters.dev_docker_repo_quay_io >>:<< parameters.tag >>"
              docker push "<< parameters.dev_docker_repo_quay_io >>:<< parameters.tag >>"
            else
              echo "Image with Tag ($image) not pushed as it is not a new point release"
            fi
            set +x
